name: Build and Release

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Create Portable Package
      run: |
        jpackage `
          --type app-image `
          --name "OnDemandAIVoice" `
          --app-version "1.0.0" `
          --vendor "AI Voice Chat" `
          --description "AI-powered voice assistant" `
          --input target/quarkus-app `
          --main-jar quarkus-run.jar `
          --icon Icon_cropped.png `
          --dest . `
          --java-options "-Xmx512m"
          
    - name: Copy Icon to Package
      run: Copy-Item "Icon_cropped.png" "OnDemandAIVoice\" -ErrorAction SilentlyContinue
      
    - name: Create README for Package
      run: |
        @"
        On-Demand AI Voice Chat - Portable Edition
        ===========================================
        
        To run the application:
        1. Double-click "OnDemandAIVoice.exe"
        2. The app will start in the system tray
        3. Press F8 to start/stop recording
        
        Configuration:
        - Edit app/application.properties to set your OpenAI API key
        - Change system prompt, voice, and other settings there
        
        IMPORTANT: You MUST set your OpenAI API key before using!
        Edit app/application.properties and set:
          app.ai.apiKey=sk-proj-your-actual-key-here
        
        Or set environment variable:
          set OPENAI_API_KEY=sk-proj-your-actual-key-here
        
        Requirements:
        - Microphone for audio input
        - Speakers for audio output
        - Internet connection for OpenAI API
        
        Press F8 to toggle recording. The AI will respond after you stop recording.
        "@ | Out-File -FilePath "OnDemandAIVoice\README.txt" -Encoding UTF8
        
    - name: Create ZIP Package
      run: Compress-Archive -Path OnDemandAIVoice -DestinationPath OnDemandAIVoice-Portable-Windows.zip -CompressionLevel Optimal
      
    - name: Get current date
      id: date
      run: echo "date=$(Get-Date -Format 'yyyy-MM-dd')" >> $env:GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: release-${{ steps.date.outputs.date }}-${{ github.run_number }}
        name: OnDemandAIVoice Release ${{ steps.date.outputs.date }}
        body: |
          ## On-Demand AI Voice Chat - Windows Portable Release
          
          ### ðŸš€ Quick Start
          1. Download `OnDemandAIVoice-Portable-Windows.zip`
          2. Extract to any folder
          3. **IMPORTANT**: Edit `OnDemandAIVoice/app/application.properties` and set your OpenAI API key
          4. Run `OnDemandAIVoice.exe`
          5. Press F8 to start/stop recording
          
          ### âœ¨ Features
          - AI-powered voice assistant using GPT-4
          - Global F8 hotkey for recording
          - Fast transcription with OpenAI Whisper
          - Natural text-to-speech responses
          - Context memory support
          - Runs in system tray
          
          ### ðŸ“‹ Requirements
          - Windows 10/11
          - Microphone
          - Internet connection
          - OpenAI API key ([Get one here](https://platform.openai.com/api-keys))
          
          ### ðŸ“¦ Package Info
          - Size: ~70 MB
          - Includes Java runtime (no installation needed)
          - Self-contained - all dependencies included
          
          Built from commit: ${{ github.sha }}
        files: |
          OnDemandAIVoice-Portable-Windows.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
